# ===========================================================================
# UniHR PostgreSQL 效能調參建議（T4-15）
# ===========================================================================
#
# 此檔案用於 PostgreSQL 正式環境調參。
# 複製到 PostgreSQL 的 conf.d/ 目錄或合併至 postgresql.conf。
#
# 基準假設：
#   - 伺服器：4 vCPU, 8GB RAM
#   - 連線數上限：~100（4 uvicorn workers × pool_size 10 + overflow 20）
#   - 以 OLTP 為主，少量報表分析查詢
# ===========================================================================

# ---------------------------------------------------------------------------
# 1. 連線管理
# ---------------------------------------------------------------------------
max_connections = 150                    # 應用連線池 + 管理連線 + 備援
superuser_reserved_connections = 3       # 預留給超級使用者

# ---------------------------------------------------------------------------
# 2. 記憶體
# ---------------------------------------------------------------------------
shared_buffers = '2GB'                   # ~25% of RAM
effective_cache_size = '6GB'             # ~75% of RAM（OS cache 含在內）
work_mem = '16MB'                        # 每個 sort/hash 操作
maintenance_work_mem = '256MB'           # VACUUM、CREATE INDEX
temp_buffers = '16MB'

# ---------------------------------------------------------------------------
# 3. WAL / Checkpoint
# ---------------------------------------------------------------------------
wal_buffers = '64MB'
checkpoint_completion_target = 0.9       # 平滑寫入
max_wal_size = '2GB'
min_wal_size = '512MB'

# ---------------------------------------------------------------------------
# 4. Query Planner
# ---------------------------------------------------------------------------
random_page_cost = 1.1                   # SSD 環境降低（預設 4.0）
effective_io_concurrency = 200           # SSD 並行 I/O
default_statistics_target = 200          # 更精確的統計

# ---------------------------------------------------------------------------
# 5. Slow Query Log
# ---------------------------------------------------------------------------
log_min_duration_statement = 500         # 記錄 >= 500ms 的查詢
log_checkpoints = on
log_connections = off                    # 正式環境關閉（量太大）
log_disconnections = off
log_lock_waits = on
log_temp_files = 0                       # 記錄所有暫存檔使用
log_autovacuum_min_duration = 0          # 記錄所有 autovacuum

# ---------------------------------------------------------------------------
# 6. Autovacuum 調參
# ---------------------------------------------------------------------------
autovacuum_max_workers = 4
autovacuum_naptime = '30s'               # 檢查頻率（預設 1min）
autovacuum_vacuum_threshold = 50         # 預設 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.05    # 5%（預設 20% 太大）
autovacuum_analyze_scale_factor = 0.025  # 2.5%
autovacuum_vacuum_cost_delay = '2ms'     # 加快 vacuum 速度

# ---------------------------------------------------------------------------
# 7. 並行查詢（PostgreSQL 15+）
# ---------------------------------------------------------------------------
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2
parallel_tuple_cost = 0.01
parallel_setup_cost = 500

# ---------------------------------------------------------------------------
# 8. 其他
# ---------------------------------------------------------------------------
idle_in_transaction_session_timeout = '5min'   # 避免長時間閒置事務
statement_timeout = '30s'                       # 查詢超時
lock_timeout = '10s'
