# aihr 系統品質與效能深度分析報告

**測試日期**: 2026-02-11 00:27  
**測試總分**: 129/129 (100%) — 自動評分  
**本報告目的**: 超越 pass/fail 分數，深入分析文件處理品質、問答內容品質、效能瓶頸

---

## 一、文件處理品質分析

### 1.1 各格式處理統計

| 格式 | 文件數 | 總 Chunks | 平均 Chunks/doc | 平均字元/chunk | 字元範圍 | 解析引擎 | 品質分數 |
|------|--------|-----------|-----------------|----------------|----------|----------|----------|
| **PDF** | 17 | 100 | 5.9 | 611 | 36~2,391 | Native | 1.0 |
| **Markdown** | 8 | 134 | 16.8 | 125 | 27~452 | Native | 1.0 |
| **TXT** | 4 | 16 | 4.0 | 1,275 | 272~2,547 | Native | 1.0 |
| **CSV** | 2 | 4 | 2.0 | 1,209 | 1,072~1,346 | Native | 1.0 |
| **Image (JPG)** | 4 | 4 | 1.0 | 363 | 342~383 | Native+OCR | 0.72 |

### 1.2 關鍵問題

#### ⚠️ 問題 1：LlamaParse 全部失敗 (嚴重)

**現象**: 系統設定 `LLAMAPARSE_ENABLED=True`，API Key 存在，但所有 PDF 的 LlamaParse 請求均回傳 **HTTP 422 Unprocessable Entity**。

```
[WARNING] LlamaParse 品質不足 (poor)，使用 native 引擎作為 fallback
```

**影響**: 所有文件僅使用 Native parser（基於 PyMuPDF/pdfplumber），無法獲得 LlamaParse 的高品質表格/版面解析。  
**根因**: 可能是 LlamaParse API 版本不相容，或請求 payload 格式不符合新版 API 規格。

#### ⚠️ 問題 2：Image OCR 品質極差 (嚴重)

**現象**: 變更登記表 JPG 圖片經 OCR 辨識後，中文文字幾乎無法閱讀：
```
RADA ATARH) ig AIRZ 4]...
```

**影響**: 
- E1 題目「變更登記表上的統一編號是多少？」→ 系統**無法提取統編**，回答「建議您上傳相關圖片」（圖片其實已上傳）
- OCR 品質分數僅 0.72，提取文字不具語義價值
- **問答 E1 雖然自動評分 3/3（因為回答長度>50字），但實質上完全失敗**

**根因**: Native OCR（可能為 Tesseract）未配置中文語言模型（`chi_tra`）。

#### ⚠️ 問題 3：Markdown 切片過度碎片化 (中度)

**現象**: Markdown 文件平均 chunk 只有 125 個字元，最小的 chunk 僅 27 字元。

**影響**: 
- 碎片 chunk 缺乏足夠上下文，降低語義檢索精度
- 大量微小 chunks 增加 embedding 成本和向量庫體積
- Token-based chunker (1000 tokens) 在 Markdown 中因 heading/list 斷行過多，導致切割點過密

**建議**: 針對 Markdown 使用結構感知切片（按 heading 層級切分），而非純 token 計數。

#### ⚠️ 問題 4：PDF chunk 大小差異極大 (中度)

**現象**: PDF chunk 字元數範圍 36~2,391，標準差極大。

**影響**: 36 字元的 chunk 提供的語義資訊幾乎為零，2,391 字元又可能超出最佳 embedding 視窗。

---

## 二、問答內容品質深度分析

### 2.1 自動評分 vs 人工品質評估

自動評分邏輯：0=無答案, 1=有答案, 2=>50字, 3=有來源 → **此評分無法檢測答案正確性**。

經逐題人工審查，以下是真實品質評估：

### 2.2 答案正確性問題（嚴重）

#### ❌ C1：平日加班 1.5 倍合法嗎？— **法律推理錯誤**

| 項目 | 內容 |
|------|------|
| 期望答案 | 優於法定 1.34 倍，**合法** |
| 系統回答 | 「公司內規的加班工資標準（1.5 倍）**低於**《勞動基準法》的最低標準（1.34 倍及1.67 倍），因此這樣的做法**不合法**」 |
| 問題 | 1.5 > 1.34，公司給更高倍率是合法的。系統將「前2小時 1.34 / 後2小時 1.67」理解為「1.5 低於 1.67」，忽略了前2小時的比較。**這是嚴重的法律判斷錯誤**。 |

#### ❌ D3：資遣 E007 劉志明的資遣費 — **計算完全錯誤**

| 項目 | 內容 |
|------|------|
| 期望答案 | 約 156,000 元（月薪 52,000 × 年資 6.0 × 0.5） |
| 系統回答 | 5,901.20 元（將月薪除以30天，再乘以年資，混淆公式） |
| 問題 | 資遣費公式 = 年資 × 0.5 × 月平均工資。系統混淆了日薪概念，計算結果差距 **26 倍**。 |

#### ❌ D4：年資最深員工 — **數據檢索不完整**

| 項目 | 內容 |
|------|------|
| 期望答案 | E005 張志豪 9.6 年 |
| 系統回答 | 謝雅玲 8.7 年 |
| 問題 | 語義檢索只召回部分員工名冊 chunks，未包含 E005 的資料。**Hybrid search 未能完整覆蓋結構化表格數據**。 |

#### ❌ D2：技術部平均月薪 — **數據不完整**

| 項目 | 內容 |
|------|------|
| 期望答案 | 59,833 元（6人） |
| 系統回答 | 66,750 元（只找到4人：65K+95K+52K+55K） |
| 問題 | 員工名冊有更多技術部員工，但 chunk 檢索只召回部分。LLM 基於不完整數據計算，結果偏差 11.5%。 |

#### ❌ 7.2.4：資遣劉志明要多少資遣費 — **年資數據錯誤**

| 項目 | 內容 |
|------|------|
| 期望答案 | 52,000 × 6.2 × 0.5 ≈ 161,200 元 |
| 系統回答 | 78,000 元（假設工作 3 年） |
| 問題 | 多輪對話情境中，前面已查到劉志明的資料，但計算資遣費時**未引用前輪查到的年資 6.2 年**，而是隨意假設 3 年。 |

#### ⚠️ E1：變更登記表統一編號 — **OCR 失敗導致無法回答**

| 項目 | 內容 |
|------|------|
| 期望答案 | OCR 辨識出 8 位數統編 |
| 系統回答 | 「建議您上傳相關圖片，系統將能協助您擷取統編資訊」 |
| 問題 | 圖片已上傳但 OCR 品質太差，提取文字無意義。系統建議重新上傳，**等於承認處理失敗**。 |

### 2.3 答案品質優秀的案例

| 題號 | 問題 | 品質評估 | 亮點 |
|------|------|----------|------|
| **A4** | 報帳計程車條件 | ⭐⭐⭐⭐⭐ | 精確列出3條件+1000元限額 |
| **A5** | 新人報到文件 | ⭐⭐⭐⭐⭐ | 完整列出8項文件，score 0.91 |
| **C3** | 生理假扣全勤 | ⭐⭐⭐⭐⭐ | 正確引用性平法§14 |
| **C5** | 配偶祖父母喪假 | ⭐⭐⭐⭐⭐ | 成功發現測試陷阱（內規6天是錯的） |
| **C6** | 連續D等解僱 | ⭐⭐⭐⭐ | 正確指出非勞基法§12事由 |
| **F1** | 劉志明實領薪資 | ⭐⭐⭐⭐⭐ | 精確到 55,244 元，完整項目明細 |
| **F2** | 勞保費自付 | ⭐⭐⭐⭐⭐ | 正確 956 元 |
| **D1** | E003 特休天數 | ⭐⭐⭐⭐⭐ | 正確 15 天 |
| **G2** | 周秀蘭特休餘額 | ⭐⭐⭐⭐⭐ | 正確 5 天 |
| **I1** | 高淑珍健檢 | ⭐⭐⭐⭐⭐ | 完整健檢報告摘要 |
| **7.2.2** | 劉志明加班費 | ⭐⭐⭐⭐⭐ | 精確 6,622 元 + 完整計時明細 |
| **E3** | 職災期間資遣 | ⭐⭐⭐⭐⭐ | 正確引用勞基法§13 |

### 2.4 修正後人工品質評估

| 評級 | 題數 | 占比 | 說明 |
|------|------|------|------|
| ⭐⭐⭐⭐⭐ 優秀 | 27 | 62.8% | 答案正確、完整、引用準確 |
| ⭐⭐⭐⭐ 良好 | 7 | 16.3% | 答案大致正確，小瑕疵 |
| ⭐⭐⭐ 可接受 | 3 | 7.0% | 有答案但有明顯遺漏 |
| ⭐⭐ 有問題 | 4 | 9.3% | 計算錯誤或數據不完整 |
| ⭐ 失敗 | 2 | 4.6% | 答案實質錯誤（C1法律判斷、D3計算） |

**人工品質評估: 實際正確率約 79%（34/43），不是自動評分的 100%。**

---

## 三、效能與延遲分析

### 3.1 問答回應時間統計（43 題）

| 指標 | 數值 |
|------|------|
| **平均** | 48.9 秒 |
| **中位數** | 47.4 秒 |
| **P90** | 67.3 秒 |
| **P95** | 77.3 秒 |
| **最快** | 8.4 秒（E007 部門查詢 — 本地 KB 直查） |
| **最慢** | 77.3 秒（法律類問題 — 需等 Core API） |

### 3.2 回應時間分布

```
 <10s  ████  1 題 (2.3%)
10-20s ████  1 題 (2.3%)
20-30s ██████████████████████████  6 題 (14.0%)
30-40s ████████████████████████████████████  8 題 (18.6%)
40-50s ██████████████████████████  6 題 (14.0%)
50-60s ████████████████████████████████████  8 題 (18.6%)
60-70s █████████████████████████████████████████  9 題 (20.9%)
 >70s  █████████████████  4 題 (9.3%)
```

### 3.3 延遲瓶頸分析

| 環節 | 耗時估算 | 說明 |
|------|----------|------|
| KB 語義檢索 | ~0.5-1s | VoyageAI embedding + pgvector ANN 查詢 |
| Core API 呼叫 | 15-30s | unihr 後端 GPT-4o 回答法律問題 |
| GPT-4o-mini 合成 | 5-15s | 最終答案生成 |
| 網路開銷 | ~1-2s | 各 API 間 |

**主要瓶頸**: Core API (unihr) 回應時間 15-30 秒，且本次測試 5 個 Worker 併發會觸發 rate limit，導致比首次測試（平均 19-28 秒）慢了約 75%。

### 3.4 效能測試階段 (Phase 8) 結果

| 題目 | 耗時 | 類型 |
|------|------|------|
| 公司上班時間 | 24.0s | 本地 KB + Core API |
| 基本工資 | 24.6s | Core API 為主 |
| E001 職稱 | 5.7s | 純本地 KB 查詢 |
| 婚假給薪 | 22.2s | Core API 為主 |
| 技術部人數 | 24.2s | 本地 KB + Core API |

**結論**: 純本地 KB 查詢 <6 秒，涉及 Core API 的一律 >20 秒。Core API 是延遲的決定性因素。

### 3.5 文件處理速度

- 23 檔上傳 → 全部 completed，258 chunks
- 平均處理時間: 大多在 10-30 秒/檔（PDF 較慢）
- **LlamaParse 失敗 → fallback 增加了約 3-5 秒無效等待**

---

## 四、檢索品質分析

### 4.1 來源相關性分數

| 分數範圍 | 題數 | 占比 | 說明 |
|----------|------|------|------|
| 0.90+ | 6 | 14% | 非常精準（如 I1 健檢、G2 請假單） |
| 0.80-0.90 | 10 | 23% | 良好匹配 |
| 0.70-0.80 | 15 | 35% | 可接受 |
| 0.60-0.70 | 9 | 21% | 較弱 |
| <0.60 | 3 | 7% | 較差（主要是需推理的衍生問題） |

### 4.2 重複來源問題

許多回答的 3 個來源中有 2-3 個是**同一文件的不同格式**（如 .md 和 .pdf 版本的員工手冊），相當於浪費了檢索 slot。

**原因**: 測試數據中每份文件同時上傳了 .md 和 .pdf 兩個版本，加上批次上傳又重複了一組，導致同一內容在向量庫中出現 2-3 次。

---

## 五、系統性問題總結

### 優先級 P0 (必須修復)

| # | 問題 | 影響 | 建議 |
|---|------|------|------|
| 1 | **LlamaParse HTTP 422** | 100% PDF 無法使用高品質解析 | 檢查 LlamaParse SDK 版本，更新 upload API payload 格式 |
| 2 | **LLM 數學計算錯誤** | 資遣費、加班費計算偏差 5-26 倍 | 將計算功能從 LLM 文本生成改為結構化計算（Function Calling 或程式碼執行） |
| 3 | **法律推理錯誤 (C1)** | 1.5>1.34 判斷為「不合法」 | 增加 Chain-of-Thought 提示，或使用更強的 GPT-4o 替代 GPT-4o-mini |

### 優先級 P1 (應該修復)

| # | 問題 | 影響 | 建議 |
|---|------|------|------|
| 4 | **Image OCR 無中文支持** | 圖片文字完全無法辨識 | 安裝 `chi_tra` Tesseract 語言包，或改用 Cloud Vision API |
| 5 | **結構化數據檢索不完整** | 員工名冊查詢遺漏記錄 | 對 CSV/表格類數據使用完整載入策略，不做 chunk 分割 |
| 6 | **自動評分機制過於寬鬆** | 100% 通過但實際 79% 正確 | 增加 LLM-as-Judge 或關鍵字匹配評分 |

### 優先級 P2 (建議改善)

| # | 問題 | 影響 | 建議 |
|---|------|------|------|
| 7 | **Markdown 碎片化** | 平均 chunk 僅 125 字元 | 改用 heading-aware 切片策略 |
| 8 | **Core API 延遲** | 50%+ 回答 >40 秒 | 增加法律問答快取；對常見問題預先建索引 |
| 9 | **多輪對話上下文丟失** | 7.2.4 未引用前輪年資數據 | 增強 session history 的上下文注入 |
| 10 | **重複文件 dedup** | 同文件 .md/.pdf 重複佔用 slot | 按 content hash 去重 |

---

## 六、結論

### 整體評估

| 維度 | 評分 | 說明 |
|------|------|------|
| **功能完整性** | ⭐⭐⭐⭐⭐ (95%) | 所有流程端到端可運行，涵蓋 7 種文件格式 |
| **答案正確率** | ⭐⭐⭐⭐ (79%) | 34/43 正確，但數學計算和法律推理有缺陷 |
| **文件處理品質** | ⭐⭐⭐ (65%) | PDF/TXT/CSV 良好，Image OCR 失敗，Markdown 碎片化 |
| **回應速度** | ⭐⭐⭐ (60%) | 平均 48.9 秒明顯過慢，Core API 為主要瓶頸 |
| **檢索精度** | ⭐⭐⭐⭐ (75%) | 大部分準確，但結構化表格數據常檢索不完整 |
| **評分系統可靠度** | ⭐⭐ (40%) | 100% 通過分數嚴重高估實際品質 |

### 改善優先順序

1. **修復 LlamaParse** → 大幅提升 PDF 和圖片解析品質
2. **升級數學計算能力** → 使用 Function Calling 進行精確計算
3. **安裝中文 OCR** → 解鎖圖片文字辨識
4. **優化結構化數據處理** → CSV/表格不分 chunk，完整載入
5. **改善評分機制** → 加入語義相似度或 LLM 評分
6. **快取法律問答** → 降低 Core API 延遲
